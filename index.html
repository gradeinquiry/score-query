<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>正式成績查詢系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        body { background-color: #f8f9fa; font-family: "Microsoft JhengHei", sans-serif; }
        .query-card { max-width: 480px; margin: 60px auto; border: none; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; }
        .card-header { background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); color: white; border: none; padding: 40px 20px; text-align: center; }
        .card-body { padding: 30px; background: white; }
        .form-label { font-weight: 600; color: #495057; }
        .form-control { border-radius: 10px; padding: 12px; border: 1px solid #ced4da; }
        .btn-query { background: #1e3a8a; color: white; border: none; border-radius: 10px; padding: 12px; font-weight: bold; width: 100%; transition: all 0.3s; }
        .btn-query:hover { background: #1e40af; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(30,58,138,0.3); }
        .result-box { display: none; margin-top: 25px; border-top: 2px solid #f1f3f5; padding-top: 25px; }
        .score-table { width: 100%; margin-bottom: 0; }
        .score-table th { color: #6c757d; font-weight: 500; padding: 10px 0; border-bottom: 1px solid #f1f3f5; }
        .score-table td { text-align: right; font-weight: 700; color: #212529; padding: 10px 0; border-bottom: 1px solid #f1f3f5; }
        .total-row { font-size: 1.25rem; color: #1e3a8a !important; }
        .footer-text { text-align: center; color: #adb5bd; font-size: 0.85rem; margin-top: 30px; }
    </style>
</head>
<body>

<div class="container">
    <div class="card query-card">
        <div class="card-header">
            <h3 class="mb-2">正式成績查詢</h3>
            <p class="mb-0 opacity-75">請輸入合併准考證號與手機末4碼</p>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label for="accountId" class="form-label">合併准考證號 (帳號)</label>
                <input type="text" id="accountId" class="form-control" placeholder="請輸入完整合併號碼" autocomplete="off">
            </div>
            <div class="mb-4">
                <label for="password" class="form-label">家長手機末4碼 (密碼)</label>
                <input type="password" id="password" class="form-control" placeholder="請輸入4位數字密碼" maxlength="4">
            </div>
            
            <button onclick="startQuery()" class="btn btn-query">立即查詢成績</button>

            <div id="loader" class="text-center mt-3" style="display:none;">
                <div class="spinner-border text-primary spinner-border-sm" role="status"></div>
                <span class="ms-2 text-muted">正在驗證資料...</span>
            </div>

            <div id="resultArea" class="result-box">
                <h5 class="text-center mb-4" id="resName" style="color:#1e3a8a;"></h5>
                <table class="score-table">
                    <tr><th>國文成績</th><td id="resChi"></td></tr>
                    <tr><th>數學成績</th><td id="resMat"></td></tr>
                    <tr><th>英文成績</th><td id="resEng"></td></tr>
                    <tr><th class="total-row">總成績</th><td id="resTotal" class="total-row"></td></tr>
                    <tr><th>全校排名</th><td id="resRank"></td></tr>
                    <tr><th>PR 值</th><td id="resPR"></td></tr>
                </table>
                <div class="alert alert-info mt-4 mb-0 py-2 text-center" style="font-size: 0.9rem;">
                    查詢成功！請確認成績無誤。
                </div>
            </div>

            <div id="errorArea" class="alert alert-danger mt-3 text-center" style="display:none; font-size: 0.9rem;"></div>
        </div>
    </div>
    <div class="footer-text">
        © 2026 學校成績查詢系統<br>
        本系統採靜態加密技術，不留存個人資料。
    </div>
</div>

<script>
    async function startQuery() {
        const accountId = document.getElementById('accountId').value.trim();
        const password = document.getElementById('password').value.trim();
        const resultArea = document.getElementById('resultArea');
        const errorArea = document.getElementById('errorArea');
        const loader = document.getElementById('loader');

        // 重置介面
        resultArea.style.display = 'none';
        errorArea.style.display = 'none';

        if (!accountId || !password) {
            showError("請填寫所有欄位");
            return;
        }

        loader.style.display = 'block';

        try {
            // 1. 生成加密檔名 (對應 tool.html 的檔名產製方式)
            const hashed = CryptoJS.SHA256(accountId).toString();
            const filePath = `./data/${hashed}.json`;

            // 2. 獲取 JSON 檔案
            const response = await fetch(filePath, { cache: "no-store" });
            
            if (!response.ok) {
                throw new Error("找不到此准考證號，請檢查輸入是否正確。");
            }

            const data = await response.json();

            // 3. 驗證密碼 (手機末4碼)
            if (String(data.verify).trim() !== password) {
                throw new Error("密碼(手機末4碼)錯誤，驗證失敗。");
            }

            // 4. 填入結果並顯示
            document.getElementById('resName').innerText = `${data.name} 同學 您好`;
            document.getElementById('resChi').innerText = data.chinese;
            document.getElementById('resMat').innerText = data.math;
            document.getElementById('resEng').innerText = data.english;
            document.getElementById('resTotal').innerText = data.total;
            document.getElementById('resRank').innerText = `第 ${data.rank} 名`;
            document.getElementById('resPR').innerText = data.pr;

            resultArea.style.display = 'block';
        } catch (error) {
            showError(error.message);
        } finally {
            loader.style.display = 'none';
        }
    }

    function showError(msg) {
        const errorArea = document.getElementById('errorArea');
        errorArea.innerText = msg;
        errorArea.style.display = 'block';
    }
</script>

</body>
</html>