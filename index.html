<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>校內成績查詢系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        body { background-color: #f0f2f5; font-family: "Microsoft JhengHei", sans-serif; }
        .query-card { max-width: 500px; margin: 50px auto; border: none; border-radius: 15px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); }
        .card-header { background: linear-gradient(135deg, #0062E6, #33AEFF); color: white; border-radius: 15px 15px 0 0 !important; padding: 30px; }
        .result-box { display: none; margin-top: 25px; border-top: 2px solid #eee; padding-top: 20px; }
        .score-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f8f9fa; }
        .score-label { color: #666; font-weight: 500; }
        .score-value { font-weight: bold; color: #333; }
        .high-light { color: #d9534f; font-size: 1.2rem; }
    </style>
</head>
<body>

<div class="container">
    <div class="card query-card">
        <div class="card-header text-center">
            <h3 class="mb-1">成績查詢系統</h3>
            <p class="mb-0 opacity-75">請輸入准考證號碼與手機末4碼驗證</p>
        </div>
        <div class="card-body p-4">
            <div class="mb-3">
                <label for="ticketId" class="form-label fw-bold">准考證號</label>
                <input type="text" id="ticketId" class="form-control form-control-lg" placeholder="例如: TN0201020" autocomplete="off">
            </div>
            <div class="mb-4">
                <label for="phoneSuffix" class="form-label fw-bold">家長手機末四碼</label>
                <input type="password" id="phoneSuffix" class="form-control form-control-lg" placeholder="驗證使用" maxlength="4">
            </div>
            
            <button onclick="performQuery()" class="btn btn-primary w-100 btn-lg shadow-sm">立即查詢</button>

            <div id="loader" class="text-center mt-3" style="display:none;">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2 text-muted">正在搜尋資料夾...</p>
            </div>

            <div id="resultArea" class="result-box">
                <div class="alert alert-success text-center fw-bold">查尋成功！</div>
                <div class="score-item"><span class="score-label">考生姓名</span><span class="score-value" id="resName"></span></div>
                <div class="score-item"><span class="score-label">國文</span><span class="score-value" id="resChi"></span></div>
                <div class="score-item"><span class="score-label">數學</span><span class="score-value" id="resMat"></span></div>
                <div class="score-item"><span class="score-label">英文</span><span class="score-value" id="resEng"></span></div>
                <div class="score-item"><span class="score-label">總成績</span><span class="score-value high-light" id="resTotal"></span></div>
                <div class="score-item"><span class="score-label">全校排名 / PR</span><span class="score-value"><span id="resRank"></span> / <span id="resPR"></span></span></div>
            </div>

            <div id="errorArea" class="alert alert-danger mt-3" style="display:none;"></div>
        </div>
    </div>
    <div class="text-center text-muted mt-4">
        <small>© 學校成績查詢系統 - 本網頁採用靜態加密技術保護個資</small>
    </div>
</div>

<script>
    async function performQuery() {
        const ticketId = document.getElementById('ticketId').value.trim();
        const phoneSuffix = document.getElementById('phoneSuffix').value.trim();
        const resultArea = document.getElementById('resultArea');
        const errorArea = document.getElementById('errorArea');
        const loader = document.getElementById('loader');

        // 隱私保護：清除舊結果
        resultArea.style.display = 'none';
        errorArea.style.display = 'none';

        if (!ticketId || !phoneSuffix) {
            showError('請完整輸入准考證號與手機末四碼');
            return;
        }

        loader.style.display = 'block';

        // 1. 生成與 Python 腳本一致的 SHA-256 雜湊檔名
        const hashedId = CryptoJS.SHA256(ticketId).toString();
        const filePath = `./data/${hashedId}.json`;

        try {
            // 2. 抓取 JSON 檔案 (強制不使用緩存，避免修改資料後沒更新)
            const response = await fetch(filePath, { cache: "no-store" });
            
            if (!response.ok) {
                throw new Error(`查無此准考證號 (${ticketId})。請確認檔案是否已上傳至 data 資料夾。`);
            }

            const data = await response.json();

            // 3. 驗證手機末四碼 (確保手機末四碼為字串且無空白)
            if (String(data.verify).trim() !== phoneSuffix) {
                throw new Error('驗證失敗：手機末四碼不正確');
            }

            // 4. 顯示結果
            document.getElementById('resName').innerText = data.name;
            document.getElementById('resChi').innerText = data.chinese;
            document.getElementById('resMat').innerText = data.math;
            document.getElementById('resEng').innerText = data.english;
            document.getElementById('resTotal').innerText = data.total;
            document.getElementById('resRank').innerText = data.rank;
            document.getElementById('resPR').innerText = data.pr;

            resultArea.style.display = 'block';
        } catch (error) {
            showError(error.message);
        } finally {
            loader.style.display = 'none';
        }
    }

    function showError(msg) {
        const errorArea = document.getElementById('errorArea');
        errorArea.innerText = msg;
        errorArea.style.display = 'block';
    }
</script>

</body>
</html>
